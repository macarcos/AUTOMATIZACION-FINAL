// ARDUINO BOMBA - Sistema Riego v2.2 SUPER CORREGIDO
// CORRECCIONES: Estado inicial OFF, botÃ³n emergencia funcional, control correcto
// Pin 7 = IN1 del relay, Pin 3 = botÃ³n emergencia

// ===== CONFIGURACIÃ“N DE PINES =====
#define RELAY_PIN 7        // Pin IN1 del relay para la bomba
#define BOTON_EMERGENCIA 3 // BotÃ³n fÃ­sico para EMERGENCIA (solo apagar)
#define BUZZER_PIN 11      // Buzzer para confirmaciÃ³n

// ===== CONFIGURACIÃ“N RELAY =====
// Define cÃ³mo se activa tu relay (false = se activa con LOW, true = se activa con HIGH).
const bool RELAY_ACTIVE_HIGH = false;

// ===== VARIABLES DE CONTROL =====
bool bombaActiva = false;            // Estado lÃ³gico de la bomba (ON/OFF).
bool botonAnterior = HIGH;           // Almacena el estado anterior del botÃ³n (para debounce).
unsigned long ultimoDebounce = 0;    // Temporizador para el debounce del botÃ³n.
const unsigned long DEBOUNCE_DELAY = 50; // 50ms para evitar rebotes del botÃ³n.

// Control de tiempos
unsigned long tiempoInicioBomba = 0; // Almacena cuÃ¡ndo se encendiÃ³ la bomba.
const unsigned long TIEMPO_MAXIMO = 300000; // 5 minutos (en ms) de funcionamiento mÃ¡ximo.
unsigned long ultimoEnvioEstado = 0; // Temporizador para enviar estado a la web.

// EstadÃ­sticas
int vecesActivada = 0; // Contador de cuÃ¡ntas veces se ha encendido.
int vecesEmergencia = 0; // Contador de paradas de emergencia.
unsigned long tiempoTotalFuncionamiento = 0; // Suma total del tiempo (ms) que ha estado activa.

// FunciÃ³n de configuraciÃ³n, se ejecuta una vez al encender.
void setup() {
    Serial.begin(9600); // Inicia comunicaciÃ³n serial (misma velocidad que JS).
    
    // Configurar pines
    pinMode(RELAY_PIN, OUTPUT); // Pin del relay como salida.
    pinMode(BOTON_EMERGENCIA, INPUT_PULLUP);  // BotÃ³n como entrada con resistencia interna.
    pinMode(BUZZER_PIN, OUTPUT); // Buzzer como salida.
    
    // CRÃTICO: ESTADO INICIAL SEGURO - BOMBA SIEMPRE OFF
    forzarBombaOFF(); // Llama a la funciÃ³n que apaga el relay fÃ­sicamente.
    bombaActiva = false; // Asegura que el estado lÃ³gico sea OFF.
    
    // Imprime el mensaje de bienvenida en el Monitor Serial.
    Serial.println(F("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"));
    Serial.println(F("â•‘  ARDUINO BOMBA v2.2 CORREGIDO    â•‘"));
    Serial.println(F("â•‘    INICIO SEGURO - BOMBA OFF     â•‘"));
    Serial.println(F("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"));
    Serial.println();
    
    // Realiza un test de hardware al iniciar.
    testInicial();
    
    // Muestra los comandos disponibles.
    Serial.println(F("âœ… Sistema listo"));
    Serial.println(F("ğŸ“± Comandos disponibles:"));
    Serial.println(F("    ON  / PUMP_ON   - Encender bomba"));
    Serial.println(F("    OFF / PUMP_OFF  - Apagar bomba"));
    Serial.println(F("    STATUS          - Ver estado"));
    Serial.println(F("    TEST            - Probar relay"));
    Serial.println(F("ğŸš¨ BotÃ³n emergencia: Pin 3 (SOLO APAGAR)"));
    Serial.println(F("ğŸ’¡ Pin relay IN1: Pin 7"));
    Serial.println(F("====================================="));
    
    // ConfirmaciÃ³n sonora (1 beep = listo).
    beep(1);
    
    // Muestra el estado inicial.
    mostrarStatus();
}

// Bucle principal, se ejecuta continuamente.
void loop() {
    // 1. ALTA PRIORIDAD: Revisa el botÃ³n de emergencia en cada ciclo.
    verificarBotonEmergencia();
    
    // 2. Revisa si la bomba ha excedido su tiempo mÃ¡ximo de encendido.
    verificarTiempoMaximo();
    
    // 3. Si hay datos en el puerto serial (comandos de la web), los procesa.
    if (Serial.available()) {
        procesarComando();
    }
    
    // 4. EnvÃ­a el estado actual (JSON) a la web cada 5 segundos.
    if (millis() - ultimoEnvioEstado >= 5000) {
        enviarEstado();
        ultimoEnvioEstado = millis();
    }
    
    delay(10); // Pausa mÃ­nima para estabilizar el loop y la lectura del botÃ³n.
}

// ===== FUNCIÃ“N CRÃTICA: FORZAR BOMBA OFF =====
// Asegura que el relay estÃ© en estado APAGADO, respetando la lÃ³gica (HIGH/LOW).
void forzarBombaOFF() {
    if (RELAY_ACTIVE_HIGH) {
        digitalWrite(RELAY_PIN, LOW);   // OFF para relay normal (activo en HIGH).
    } else {
        digitalWrite(RELAY_PIN, HIGH);  // OFF para relay invertido (activo en LOW).
    }
    
    // Imprime el estado fÃ­sico real del pin del relay para depuraciÃ³n.
    Serial.println(F("ğŸ›‘ BOMBA FORZADA A OFF (seguridad)"));
    Serial.print(F("ğŸ”§ Pin IN1 ("));
    Serial.print(RELAY_PIN);
    Serial.print(F("): "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
}

// ===== BOTÃ“N DE EMERGENCIA MEJORADO =====
// Verifica si el botÃ³n fÃ­sico de emergencia ha sido presionado.
void verificarBotonEmergencia() {
    bool estadoActual = digitalRead(BOTON_EMERGENCIA); // Lee el estado actual del pin.
    
    // Detecta un cambio en el estado del botÃ³n.
    if (estadoActual != botonAnterior) {
        ultimoDebounce = millis(); // Registra el tiempo del cambio.
    }
    
    // Si el estado se ha mantenido estable por mÃ¡s tiempo que el DEBOUNCE_DELAY...
    if ((millis() - ultimoDebounce) > DEBOUNCE_DELAY) {
        // Detecta el momento exacto de la presiÃ³n (flanco descendente: de HIGH a LOW).
        if (botonAnterior == HIGH && estadoActual == LOW) {
            
            // Si la bomba estaba activa, la apaga.
            if (bombaActiva) {
                Serial.println(F("ğŸš¨ Â¡BOTÃ“N EMERGENCIA PRESIONADO!"));
                Serial.println(F("ğŸ›‘ APAGANDO BOMBA INMEDIATAMENTE"));
                
                apagarBomba(); // Llama a la funciÃ³n de apagado.
                vecesEmergencia++; // Incrementa el contador de emergencias.
                
                beep(3); // 3 beeps rÃ¡pidos = emergencia.
                
                Serial.print(F("ğŸ“Š Paradas de emergencia totales: "));
                Serial.println(vecesEmergencia);
            } else {
                // Si la bomba ya estaba apagada, solo informa.
                Serial.println(F("ğŸš¨ BotÃ³n emergencia presionado"));
                Serial.println(F("ğŸ’¡ Bomba ya estÃ¡ apagada"));
                beep(1); // 1 beep = confirmaciÃ³n.
            }
        }
    }
    
    botonAnterior = estadoActual; // Guarda el estado actual para el prÃ³ximo ciclo.
}

// ===== FUNCIONES DE CONTROL DE BOMBA =====
// Activa el relay y actualiza el estado a ENCENDIDO.
void encenderBomba() {
    if (!bombaActiva) { // Solo actÃºa si la bomba estÃ¡ apagada.
        bombaActiva = true; // Actualiza el estado lÃ³gico.
        tiempoInicioBomba = millis(); // Registra la hora de inicio.
        vecesActivada++; // Incrementa el contador de usos.
        
        // Escribe en el pin del relay segÃºn la configuraciÃ³n (ACTIVE_HIGH/LOW).
        if (RELAY_ACTIVE_HIGH) {
            digitalWrite(RELAY_PIN, HIGH);
        } else {
            digitalWrite(RELAY_PIN, LOW);
        }
        
        Serial.println(F("âœ… BOMBA ENCENDIDA"));
        Serial.print(F("ğŸ”„ ActivaciÃ³n #"));
        Serial.println(vecesActivada);
        Serial.print(F("ğŸ”§ Relay IN1 activado: "));
        Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
        Serial.println(F("â±ï¸ Tiempo mÃ¡ximo: 5 minutos"));
        
        beep(2); // Dos beeps = encendido.
    } else {
        Serial.println(F("âš ï¸ Bomba ya estÃ¡ encendida"));
    }
}

// Desactiva el relay y actualiza el estado a APAGADO.
void apagarBomba() {
    if (bombaActiva) { // Solo actÃºa si la bomba estÃ¡ encendida.
        // Calcula cuÃ¡nto tiempo estuvo encendida.
        unsigned long tiempoFuncionamiento = millis() - tiempoInicioBomba;
        tiempoTotalFuncionamiento += tiempoFuncionamiento; // Suma al total histÃ³rico.
        
        bombaActiva = false; // Actualiza el estado lÃ³gico.
        
        // Llama a la funciÃ³n de apagado forzado (mÃ¡s segura).
        forzarBombaOFF();
        
        Serial.println(F("ğŸ›‘ BOMBA APAGADA"));
        Serial.print(F("â±ï¸ FuncionÃ³ por: "));
        Serial.print(tiempoFuncionamiento / 1000); // Muestra el tiempo en segundos.
        Serial.println(F(" segundos"));
        
        beep(1); // Un beep = apagado.
    } else {
        Serial.println(F("âš ï¸ Bomba ya estÃ¡ apagada"));
    }
}

// ===== VERIFICAR TIEMPO MÃXIMO =====
// ProtecciÃ³n para evitar que la bomba funcione indefinidamente si algo falla.
void verificarTiempoMaximo() {
    // Si la bomba estÃ¡ activa Y ha superado el tiempo mÃ¡ximo...
    if (bombaActiva && (millis() - tiempoInicioBomba >= TIEMPO_MAXIMO)) {
        Serial.println(F("âš ï¸ PROTECCIÃ“N: Tiempo mÃ¡ximo alcanzado (5 min)"));
        Serial.println(F("ğŸ›‘ Apagando automÃ¡ticamente..."));
        
        apagarBomba(); // Apaga la bomba.
        
        beep(5); // 5 beeps = alarma de protecciÃ³n.
    }
}

// ===== PROCESAR COMANDOS SERIE =====
// Lee y ejecuta los comandos recibidos desde la Web App (JS).
void procesarComando() {
    String comando = Serial.readStringUntil('\n'); // Lee el texto hasta el salto de lÃ­nea.
    comando.trim(); // Limpia espacios en blanco.
    comando.toUpperCase(); // Convierte a mayÃºsculas (ON, OFF, STATUS).
    
    Serial.print(F("ğŸ“¨ Comando recibido: '"));
    Serial.print(comando);
    Serial.println(F("'"));
    
    // Ejecuta la funciÃ³n correspondiente al comando.
    if (comando == "ON" || comando == "PUMP_ON") {
        encenderBomba();
    }
    else if (comando == "OFF" || comando == "PUMP_OFF") {
        apagarBomba();
    }
    else if (comando == "STATUS") {
        mostrarStatus();
    }
    else if (comando == "TEST") {
        testRelay();
    }
    else if (comando == "RESET") {
        // Resetea los contadores de estadÃ­sticas.
        vecesActivada = 0;
        vecesEmergencia = 0;
        tiempoTotalFuncionamiento = 0;
        Serial.println(F("ğŸ”„ EstadÃ­sticas reseteadas"));
    }
    else if (comando.length() > 0) {
        // Informa si el comando no se reconoce.
        Serial.print(F("â“ Comando desconocido: '"));
        Serial.print(comando);
        Serial.println(F("'"));
        Serial.println(F("ğŸ’¡ Comandos: ON, OFF, STATUS, TEST, RESET"));
    }
}

// ===== ENVIAR ESTADO (JSON para web app) =====
// EnvÃ­a el estado actual en formato JSON, para que la Web App lo entienda.
void enviarEstado() {
    Serial.print(F("{\"pump_active\":")); // Inicio del JSON.
    Serial.print(bombaActiva ? F("true") : F("false"));
    Serial.print(F(",\"activations\":"));
    Serial.print(vecesActivada);
    Serial.print(F(",\"emergencies\":"));
    Serial.print(vecesEmergencia);
    Serial.print(F(",\"total_time\":"));
    Serial.print(tiempoTotalFuncionamiento / 1000); // EnvÃ­a tiempo total en segundos.
    
    // Si la bomba estÃ¡ encendida, aÃ±ade el tiempo actual y restante.
    if (bombaActiva) {
        Serial.print(F(",\"current_time\":"));
        Serial.print((millis() - tiempoInicioBomba) / 1000);
        Serial.print(F(",\"time_left\":"));
        Serial.print((TIEMPO_MAXIMO - (millis() - tiempoInicioBomba)) / 1000);
    }
    
    Serial.println(F("}")); // Fin del JSON y salto de lÃ­nea.
}

// ===== MOSTRAR STATUS COMPLETO =====
// Imprime un reporte detallado del estado en el Monitor Serial (para depuraciÃ³n).
void mostrarStatus() {
    Serial.println(F("â•”â•â•â•â•â•â•â•â•â•â•â• ESTADO BOMBA â•â•â•â•â•â•â•â•â•â•â•â•—"));
    Serial.print(F("â•‘ Estado actual: "));
    if (bombaActiva) {
        Serial.println(F("ENCENDIDA âœ…"));
    } else {
        Serial.println(F("APAGADA âŒ"));
    }
    
    Serial.print(F("â•‘ Pin relay IN1 ("));
    Serial.print(RELAY_PIN);
    Serial.print(F("): "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    
    Serial.print(F("â•‘ Activaciones totales: "));
    Serial.println(vecesActivada);
    
    Serial.print(F("â•‘ Paradas emergencia: "));
    Serial.println(vecesEmergencia);
    
    Serial.print(F("â•‘ Tiempo total funcionamiento: "));
    Serial.print(tiempoTotalFuncionamiento / 1000);
    Serial.println(F(" seg"));
    
    if (bombaActiva) {
        unsigned long tiempoActual = millis() - tiempoInicioBomba;
        Serial.print(F("â•‘ Tiempo funcionando: "));
        Serial.print(tiempoActual / 1000);
        Serial.println(F(" seg"));
        
        unsigned long tiempoRestante = TIEMPO_MAXIMO - tiempoActual;
        Serial.print(F("â•‘ Tiempo restante: "));
        Serial.print(tiempoRestante / 1000);
        Serial.println(F(" seg"));
    }
    
    Serial.print(F("â•‘ BotÃ³n emergencia ("));
    Serial.print(BOTON_EMERGENCIA);
    Serial.print(F("): "));
    Serial.println(digitalRead(BOTON_EMERGENCIA) ? F("NO presionado") : F("PRESIONADO"));
    
    Serial.println(F("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"));
}

// ===== TEST INICIAL DEL SISTEMA =====
// Prueba rÃ¡pida de hardware al inicio.
void testInicial() {
    Serial.println(F("ğŸ”§ TEST INICIAL DEL SISTEMA"));
    
    // 1. Test del relay
    Serial.println(F("1ï¸âƒ£ Probando relay..."));
    Serial.print(F("    ConfiguraciÃ³n: "));
    Serial.println(RELAY_ACTIVE_HIGH ? F("ACTIVE HIGH") : F("ACTIVE LOW"));
    Serial.print(F("    Pin IN1 inicial: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW")); // Debe estar en estado OFF.
    
    // 2. Test del botÃ³n
    Serial.println(F("2ï¸âƒ£ Probando botÃ³n emergencia..."));
    Serial.print(F("    Estado botÃ³n pin "));
    Serial.print(BOTON_EMERGENCIA);
    Serial.print(F(": "));
    Serial.println(digitalRead(BOTON_EMERGENCIA) ? F("HIGH (no presionado)") : F("LOW (presionado)"));
    
    // 3. Test del buzzer
    Serial.println(F("3ï¸âƒ£ Probando buzzer..."));
    beep(1);
    
    Serial.println(F("âœ… Test inicial completado"));
    Serial.println();
}

// ===== TEST COMPLETO DEL RELAY =====
// Prueba manual (vÃ­a comando "TEST") para encender y apagar el relay.
void testRelay() {
    Serial.println(F("ğŸ”§ INICIANDO PRUEBA COMPLETA DEL RELAY"));
    
    bool estadoOriginal = bombaActiva; // Guarda el estado actual de la bomba.
    
    if (bombaActiva) {
        Serial.println(F("âš ï¸ Bomba estÃ¡ activa - serÃ¡ incluida en el test"));
    }
    
    Serial.println(F(""));
    Serial.println(F("1ï¸âƒ£ Estado OFF (seguro)"));
    forzarBombaOFF(); // Apaga la bomba.
    Serial.print(F("    Pin IN1: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    delay(2000);
    
    Serial.println(F("2ï¸âƒ£ Estado ON (3 segundos)"));
    // Activa el relay (segÃºn la configuraciÃ³n).
    if (RELAY_ACTIVE_HIGH) {
        digitalWrite(RELAY_PIN, HIGH);
    } else {
        digitalWrite(RELAY_PIN, LOW);
    }
    Serial.print(F("    Pin IN1: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    Serial.println(F("    ğŸ‘‚ Escucha el 'click' del relay"));
    Serial.println(F("    ğŸ‘€ Observa si la bomba funciona"));
    delay(3000);
    
    Serial.println(F("3ï¸âƒ£ Regresando a OFF"));
    forzarBombaOFF(); // Apaga la bomba.
    Serial.print(F("    Pin IN1: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    
    // Si la bomba estaba encendida antes del test, la vuelve a encender.
    if (estadoOriginal) {
        Serial.println(F("ğŸ”„ Restaurando estado original..."));
        encenderBomba();
    }
    
    Serial.println(F(""));
    Serial.println(F("âœ… PRUEBA COMPLETADA"));
    Serial.println(F("ğŸ” Si no funcionÃ³:"));
    Serial.println(F("    â€¢ Verifica conexiones IN1 â†’ Pin 7"));
    Serial.println(F("    â€¢ Verifica alimentaciÃ³n del relay"));
    Serial.println(F("    â€¢ Verifica conexiones de la bomba"));
    Serial.println(F(""));
}

// ===== FUNCIÃ“N BUZZER =====
// Genera 'cantidad' de beeps cortos.
void beep(int cantidad) {
    for (int i = 0; i < cantidad; i++) {
        digitalWrite(BUZZER_PIN, HIGH);
        delay(100); // DuraciÃ³n del beep.
        digitalWrite(BUZZER_PIN, LOW);
        if (i < cantidad - 1) delay(150); // Pausa entre beeps.
    }
}
